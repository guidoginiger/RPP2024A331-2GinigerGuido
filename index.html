<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperatorio Primer Parcial Laboratorio III</title>

    <link rel="stylesheet" href="estilos.css">
</head>

<body>
    <!-- PUNTO 3) FORMULARIO DATOS -->
    <form id="formulario_datos">
        <h1>Form Datos</h1>

        <!-- FILTRAR POR -->
        <div class="contenedor">
            <label for="filtro">Filtrar por:</label>
            <select id="filtro" name="filtro">
                <option value="todos">Todos</option>
                <option value="futbolista">Futbolistas</option>
                <option value="profesional">Profesionales</option>
            </select>
        </div>

        <!-- CHECKBOXES -->
        <div class="checkbox">
            <input type="checkbox" id="id_checkbox" name="id" value="id" checked> ID
            <input type="checkbox" id="nombre_checkbox" name="nombre" value="nombre" checked> Nombre
            <input type="checkbox" id="apellido_checkbox" name="apellido" value="apellido" checked> Apellido
            <input type="checkbox" id="edad_checkbox" name="edad" value="edad" checked> Edad
            <input type="checkbox" id="equipo_checkbox" name="equipo" value="equipo" checked> Equipo
            <input type="checkbox" id="posicion_checkbox" name="posicion" value="posicion" checked> Posicion
            <input type="checkbox" id="cantGoles_checkbox" name="cant_Goles" value="cantGoles" checked> CantGoles
            <input type="checkbox" id="titulo_checkbox" name="titulo" value="titulo" checked> Titulo
            <input type="checkbox" id="facultad_checkbox" name="facultad" value="facultad" checked> Facultad
            <input type="checkbox" id="anoGrad_checkbox" name="ano_Grad" value="añoGrad" checked> AñoGrad
        </div>

        <!-- CALCULAR EDAD PROMEDIO -->
        <div class="contenedor">
            <label id="edad_promedio">Calcular Edad Promedio:</label>
            <input type="num" id="input_edad_promedio" readonly>
            <button type="button" onclick="calcularEdadPromedio()">Calcular</button>
        </div>

        <p id="mensaje_error"></p>

        <!-- TABLA -->
        <table id="tabla_datos">

            <!-- ENCABEZADO de la tabla -->
            <thead id="encabezado_tabla">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Edad</th>
                    <th>Equipo</th>
                    <th>Posicion</th>
                    <th>CantGoles</th>
                    <th>Titulo</th>
                    <th>Facultad</th>
                    <th>AñoGrad</th>
                </tr>
            </thead>

            <!-- CUERPO de la tabla -->
            <tbody id="tabla_cuerpo_inicial">
                <tr>
                    <td>--</td>
                    <td>--</td>
                    <td>--</td>
                    <td>--</td>
                    <td>--</td>
                    <td>--</td>
                    <td>--</td>
                    <td>--</td>
                </tr>
            </tbody>

            <tbody id="cuerpo_tabla">

            </tbody>
        </table>

        <br>

        <!-- BOTON AGREGAR PERSONA -->
        <div>
            <button type="button" onclick="agregarPersona()">Agregar</button>
        </div>

    </form>
    <!-- FIN FORMULARIO DATOS -->

    <!-- FORMULARIO ABM -->
    <div id="form_abm">

        <form id="formulario_abm" style="display: none;">
            <h1>Formulario ABM</h1>

            <!-- ID -->
            <div class="contenedor">
                <label for="id_persona">ID: </label>
                <input type="number" id="id_persona" name="id_persona" readonly>
            </div>

            <!-- NOMBRE -->
            <div class="contenedor">
                <label for="nombre">Nombre: </label>
                <input type="text" id="nombre" name="nombre">
            </div>

            <!-- APELLIDO -->
            <div class="contenedor">
                <label for="apellido">Apellido: </label>
                <input type="text" id="apellido" name="apellido">
            </div>

            <!-- EDAD -->
            <div class="contenedor">
                <label for="edad">Edad: </label>
                <input type="number" id="edad" name="edad">
            </div>

            <p id="mensaje_error_abm"></p>

            <!-- TIPO -->
            <div class="contenedor">
                <label for="tipo">Tipo: </label>
                <select id="tipo" name="tipo">
                    <option value="" selected disabled>Seleccionar tipo </option>
                    <option value="terrestre">Terrestre</option>
                    <option value="aereo">Aereo</option>
                </select>
            </div>

            <div id="botones_fin_form"></div>
    
            <!-- BOTONES ACEPTAR / MODIFICAR / ELIMINAR / CANCELAR -->
            <div class="contenedor">
                    <button type="button" id='botonAceptar' onclick="guardarDatos()">Aceptar </button>
                    <!-- 
                    <button type="button" id='botonModificar' onclick="modificarDatos()">Modificar </button>
                    <button type="button" id='botonEliminar' onclick="eliminarVehiculo()">Eliminar </button>
                    -->
                    <button type="button" id="mostrarFormularioBtn" onclick="mostrarFormulario()">Cancelar </button>
            </div>
            
        </form>
        <!-- FIN FORMULARIO ABM -->

    </div>

    <!-- SCRIPT, JAVASCRIPT -->
    <script>

        // PUNTO 1)
        class Persona
        {
            constructor(id, nombre, apellido, edad){
                this.id = id;
                this.nombre = nombre;
                this.apellido = apellido;
                this.edad = edad;
            }

            toString()
            {
                return `Id: ${this.id}, Nombre: ${this.nombre}, Apellido: ${this.apellido}, Edad: ${this.edad}`;
            }
        }

        class Futbolista extends Persona
        {
            constructor(id, nombre, apellido, edad, equipo, posicion, cantidadGoles)
            {
                super(id, nombre, apellido, edad);

                this.equipo = equipo;
                this.posicion = posicion;
                this.cantidadGoles = cantidadGoles;
            }

            toString()
            {
                return `${super.toString()}, Equipo: ${this.equipo}, Posicion: ${this.posicion}, Cantidad de goles: ${this.cantidadGoles}`;
            }
        }

        class Profesional extends Persona
        {
            constructor(id, nombre, apellido, edad, titulo, facultad, anoGraduacion)
            {
                super(id, nombre, apellido, edad);

                this.titulo = titulo;
                this.facultad = facultad;
                this.anoGraduacion = anoGraduacion;
            }

            toString()
            {
                return `${super.toString()}, Titulo: ${this.titulo}, Facultad: ${this.facultad}, Año de Graduación: ${this.anoGraduacion}`;
            }
            
        }

        // PUNTO 2)
        var personas_json = '[{"id":1, "nombre":"Marcelo", "apellido":"Luque", "edad":45, "titulo":"Ingeniero", "facultad":"UTN", "añoGraduacion":2002},{"id":2, "nombre":"Ramiro", "apellido":"Escobar", "edad":35, "titulo":"Medico", "facultad":"UBA", "añoGraduacion":20012},{"id":3, "nombre":"Facundo", "apellido":"Cairo", "edad":30, "titulo":"Abogado", "facultad":"UCA", "añoGraduacion":2017},{"id":4, "nombre":"Fernando", "apellido":"Nieto", "edad":18, "equipo":"Independiente", "posicion":"Delantero", "cantidadGoles":7},{"id":5, "nombre":"Manuel", "apellido":"Loza", "edad":20, "equipo":"Racing", "posicion":"Volante", "cantidadGoles":2},{"id":6, "nombre":"Nicolas", "apellido":"Serrano", "edad":23, "equipo":"Boca", "posicion":"Arquero", "cantidadGoles":0}]';
        var personas_array = JSON.parse(personas_json);

        var personas_instanciadas_array = [];

        personas_array.forEach(persona => {

            if(persona.equipo !== undefined && persona.posicion !== undefined && persona.cantidadGoles !== undefined)
            {
                let personaFutbolista = new Futbolista(persona.id, persona.nombre, persona.apellido, persona.edad, persona.equipo, persona.posicion, persona.cantidadGoles);
                personas_instanciadas_array.push(personaFutbolista);                
            }
            else if(persona.titulo !== undefined && persona.facultad !== undefined && persona.anoGraduacion!== undefined)
            {
                let personaProfesional = new Profesional(persona.id, persona.nombre, persona.apellido, persona.edad, persona.titulo, persona.facultad, persona.anoGraduacion);
                personas_instanciadas_array.push(personaProfesional);
            }
        });

        // FUNCIONES
        function mayusculaPrimerLetra(palabra)
        {
            return palabra.charAt(0).toUpperCase() + palabra.slice(1);
        }


        function mostrar()
        {
            document.getElementById('filtro').value = 'todos';

            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });

            mostrarDatos();
            
            document.getElementById('filtro').addEventListener('change', () => {
                mostrarDatos();
            });
        }

        mostrar();

        function mostrarFormulario()
        {
            document.getElementById('encabezado_tabla').style.display = "table-header-group";
            document.getElementById('formulario_datos').style.display = 'block';
            document.getElementById('formulario_abm').style.display = 'none';

            let mensaje = document.getElementById("mensaje_error_abm");
            mensaje.innerText = "";

            document.getElementById('tabla_cuerpo_inicial').style.display = 'table-row-group'

            vaciarFormularioABM();
            vaciarFormularioPrincipal();
            mostrar();
        }

        function calcularEdadPromedio()
        {
            let filtro = document.getElementById('filtro').value;
            let vehiculos_filtrados;

            if(filtro === 'todos')
            {
                vehiculos_filtrados = vehiculos_instanciados_array;
            }
            else if(filtro === 'aereo')
            {
                vehiculos_filtrados = vehiculos_instanciados_array.filter(vehiculo => vehiculo instanceof Aereo);
            }
            else if (filtro === 'terrestre')
            {
                vehiculos_filtrados = vehiculos_instanciados_array.filter(vehiculo => vehiculo instanceof Terrestre);
            }

            let suma = vehiculos_filtrados.reduce((acumulador, vehiculo) => acumulador + vehiculo.velMax, 0);
            let promedio = (suma / vehiculos_filtrados.length).toFixed(2);

            document.getElementById('input_edad_promedio').value = promedio;
        }

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                mostrarDatos();
            });
        });

        function mostrarDatos()
        {
            let columnasCheckeadas = [];
            let cuerpoTabla = document.getElementById('cuerpo_tabla');
            cuerpoTabla.innerHTML = "";            

            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                columnasCheckeadas.push(checkbox.value);
            });
            let mensajeError = document.getElementById('mensaje_error');

            let encabezadoTabla = document.getElementById('encabezado_tabla');
            if(columnasCheckeadas.length === 0)
            {
                document.getElementById('tabla_cuerpo_inicial').style.display = 'table-row-group'
                mensajeError.textContent = "ERROR. Elegir propiedad";
                encabezadoTabla.style.display = "table-header-group";
                return;
            }
            else
            {
                document.getElementById('tabla_cuerpo_inicial').style.display = 'none';
                mensajeError.textContent = "";
                encabezadoTabla.style.display = "none";
            }

            let encabezado_html = "<tr>";
            
            columnasCheckeadas.forEach(columna => {
                encabezado_html += `<th id="titulo_${columna}" class="encabezado-tabla">${mayusculaPrimerLetra(columna)} </th>`;
            });
            encabezado_html += "</tr>";
            cuerpoTabla.innerHTML += encabezado_html;

            let filtro = document.getElementById('filtro').value;
            let vehiculos_filtrados;

            if(filtro === 'todos')
            {
                vehiculos_filtrados = vehiculos_instanciados_array;
            }
            else if(filtro === 'aereo')
            {
                vehiculos_filtrados = vehiculos_instanciados_array.filter(vehiculo => vehiculo instanceof Aereo);
            }
            else if(filtro === 'terrestre')
            {
                vehiculos_filtrados = vehiculos_instanciados_array.filter(vehiculo => vehiculo instanceof Terrestre);
            }

            columnasCheckeadas.forEach(columna => {
                document.getElementById(`titulo_${columna}`).addEventListener('click', () => {
                    vehiculos_filtrados.sort((a, b) => {
                        if(a[columna] < b[columna])
                        {
                            return -1; 
                        }
                        if(a[columna] > b[columna])
                        {
                            return 1; 
                        }
                        return 0;
                    });

                    mostrarDatos();
                });
            });

            vehiculos_filtrados.forEach(vehiculo => {
                let fila_html = "<tr>";
                columnasCheckeadas.forEach(columna => {
                    let dato_fila = vehiculo[columna] || "--";
                    fila_html += `<td id="dato_fila_vehiculo_con_id_${vehiculo.id}_${columna}">${dato_fila}</td>`;
                });
                fila_html += "</tr>";

                let fila = document.createElement('tr');
                fila.innerHTML = fila_html;

                fila.addEventListener('dblclick', () => {
                    obtenerVehiculoABM(vehiculo.id);
                });
                
                cuerpoTabla.appendChild(fila);
            });
        }


        function obtenerVehiculoABM(id_persona)
        {
            document.getElementById('id_persona').value = id_persona;

            document.getElementById('formulario_datos').style.display = 'none';
            document.getElementById('mostrarFormularioBtn').style.display = 'block';
            document.getElementById('formulario_abm').style.display = 'block';            
            document.getElementById('botonAceptar').style.display = 'none'; 
            document.getElementById('botonModificar').style.display = 'block';
            document.getElementById('botonEliminar').style.display = 'block';

            const camposAdicionales = document.getElementById('botones_fin_form');
            camposAdicionales.innerHTML = '';

            let vehiculo = vehiculos_instanciados_array.find(vehiculo => vehiculo.id === id_persona);
            document.getElementById('modelo').value = vehiculo.modelo;
            document.getElementById('anoFab').value = vehiculo.anoFab;
            document.getElementById('velMax').value = vehiculo.velMax;

            let tipo = document.getElementById('tipo');
            if(vehiculo instanceof Terrestre)
            {
                tipo.value = 'terrestre';
            }
            else
            {
                tipo.value = 'aereo';
            }

            mostrarTiposSeleccionados();

            if(tipo.value == 'terrestre')
            {
                document.getElementById('cantPue').value = vehiculo.cantPue;
                document.getElementById('cantRue').value = vehiculo.cantRue;
            }
            else
            {
                document.getElementById('altMax').value = vehiculo.altMax;
                document.getElementById('autonomia').value = vehiculo.autonomia;
            }
        }

        function modificarDatos()
        {
            let id_persona = document.getElementById('id_persona').value;
            let modelo = document.getElementById('modelo').value;
            let anoFab = document.getElementById('anoFab').value;
            let velMax = document.getElementById('velMax').value;
            let cantPue = document.getElementById('cantPue');
            let cantRue = document.getElementById('cantRue');
            let altMax = document.getElementById('altMax');
            let autonomia = document.getElementById('autonomia');
            let tipo = document.getElementById('tipo').value;

            let mensaje = document.getElementById("mensaje_error_abm");

            let vehiculo = vehiculos_instanciados_array.find(vehiculo => vehiculo.id === id_persona);

            if (!vehiculo)
            {
                mensaje.innerText = "ERROR. No se encontró el vehículo";
                return;
            }

            if (modelo === "" || anoFab === "" || anoFab <= 1885 || isNaN(velMax) || velMax === "" || velMax < 1)
            {
                mensaje.innerText = "ERROR. Faltan completar datos. (El año de fabricacion tiene que ser mayor a 1885 y la velocidad mayor a 0)";
            } 
            else {
                vehiculo.modelo = modelo;
                vehiculo.anoFab = anoFab; 
                vehiculo.velMax = velMax; 

                if (tipo === 'terrestre') {
                    if (isNaN(cantPue.value) || cantPue.value === "" || isNaN(cantRue.value) || cantRue.value === "")
                    {
                        mensaje.innerText = "ERROR. Faltan completar datos";
                        return;
                    } else {
                        vehiculo.cantPue = cantPue.value; 
                        vehiculo.cantRue = cantRue.value; 
                    }
                }
                else if (tipo === 'aereo') 
                {
                    if (isNaN(altMax.value) || altMax.value === "" || isNaN(autonomia.value) || autonomia.value === ""){
                        mensaje.innerText = "ERROR. Faltan completar datos";
                        return;
                    } else {
                        vehiculo.altMax = altMax.value; 
                        vehiculo.autonomia = autonomia.value; 
                    }
                }

                alert(`Los datos de ${vehiculo.modelo} se modificaron`);

                mostrarFormulario();
            }
        }

        function agregarPersona()
        {
            document.getElementById('formulario_datos').style.display = 'none';
            document.getElementById('mostrarFormularioBtn').style.display = 'block';
            document.getElementById('formulario_abm').style.display = 'block';
            document.getElementById('botonModificar').style.display = 'none';
            document.getElementById('botonAceptar').style.display = 'block';
            document.getElementById('botonEliminar').style.display = 'none';

            const camposAdicionales = document.getElementById('botones_fin_form');
            camposAdicionales.innerHTML = '';
        }

        function eliminarVehiculo()
        {            
            let id_persona = document.getElementById('id_persona').value;
            let indice = vehiculos_instanciados_array.findIndex(vehiculo => vehiculo.id === id_persona);
            let vehiculo = vehiculos_instanciados_array[indice];

            if (indice === -1) {
                alert('Vehículo no encontrado.');
                return; 
            }

            let confirmar_eliminar = confirm(`¿Eliminar ${vehiculo}?`);

            if(confirmar_eliminar == true)
            {
                vehiculos_instanciados_array.splice(indice, 1);

                mostrarFormulario();
                mostrar();
            }            
        }

        function vaciarFormularioPrincipal()
        {
            let cuerpoTabla = document.getElementById('cuerpo_tabla');
            cuerpoTabla.innerHTML = "";

            let modelo = document.getElementById('modelo');
            modelo.innerText = "";

            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            document.getElementById('input_edad_promedio').value = "";
        }

        function guardarDatos()
        {
            let faltan_datos = false;
            let mensaje = document.getElementById("mensaje_error_abm");
            mensaje.innerText = "";

            let id = vehiculos_instanciados_array.length + 1;
            let modelo = document.getElementById('modelo').value;
            let anoFab = document.getElementById('anoFab').value;
            let velMax = parseInt(document.getElementById('velMax').value);
            let tipo = document.getElementById('tipo').value;

            if (modelo === "" || anoFab <= 1885 || isNaN(velMax) || velMax < 0 || !tipo)
            {
                mensaje.textContent = "ERROR. Ingresar datos en todos los campos. (El año de fabricación tiene que ser mayor a 1885)";
                faltan_datos = true;
            }

            if(tipo === 'terrestre')
            {
                let cantPue = parseFloat(document.getElementById('cantPue').value);
                let cantRue = document.getElementById('cantRue').value;

                if (isNaN(cantPue) || cantPue < 0 || isNaN(cantRue) || cantRue < 1)
                {
                    mensaje.textContent = "ERROR. Reingrese cantidad de puertas y ruedas correspondientes.";
                    faltan_datos = true;
                }

                if (!faltan_datos) 
                {
                    let nuevoTerrestre = new Terrestre(id, modelo, anoFab, velMax, cantPue, cantRue);
                    vehiculos_instanciados_array.push(nuevoTerrestre);
                }

            }
            else if(tipo === 'aereo')
            {
                let altMax = parseFloat(document.getElementById('altMax').value);
                let autonomia = parseFloat(document.getElementById('autonomia').value);
                
                if (isNaN(altMax) || isNaN(autonomia) || altMax < 1 || autonomia <= 0)
                {
                    mensaje.textContent = "ERROR. Reingrese altura máxima y autonomia válidas. (Tienen que ser mayor a 0)";
                    faltan_datos = true;
                }

                if (!faltan_datos)
                {
                    let nuevoAereo = new Aereo(id, modelo, anoFab, velMax, altMax, autonomia);
                    vehiculos_instanciados_array.push(nuevoAereo);
                }
            }

            if (!faltan_datos)
            {
                mostrarFormulario();
                mostrar();
            }
        }

        function mostrarTiposSeleccionados()
        {
            const tipo = document.getElementById('tipo').value;
            const camposAdicionales = document.getElementById('botones_fin_form');
            camposAdicionales.innerHTML = ''; 

            if(tipo === 'terrestre')
            {
                camposAdicionales.innerHTML = `
                   <label for="cantPue">Cantidad de Puertas:</label>
                   <input type="number" id="cantPue" name="cantPue">
                   <label for="cantRue">Cantidad de Ruedas:</label>
                   <input type="number" id="cantRue" name="cantRue">
               `;
            }
            else if(tipo === 'aereo')
            {
                camposAdicionales.innerHTML = `
                   <label for="altMax">Altura Maxima: </label>
                   <input type="number" id="altMax" name="altMax">
                   <label for="autonomia">Autonomia: </label>
                   <input type="number" id="autonomia" name="autonomia">
               `;
            }
        }

        document.getElementById('tipo').addEventListener('change', mostrarTiposSeleccionados);
        
        function vaciarFormularioABM()
        {
            document.querySelectorAll('#formulario_abm input').forEach(input => {
                input.value = '';
            });

            document.getElementById('tipo').value = '';
            document.getElementById('botones_fin_form').innerHTML = '';
        }
    </script>
    
</body>
</html>